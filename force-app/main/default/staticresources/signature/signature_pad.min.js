!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.SignaturePad=e()}(this,function(){"use strict";function t(t,e,o){this.x=t,this.y=e,this.time=o||(new Date).getTime()}function e(t,e,o,i){this.startPoint=t,this.control1=e,this.control2=o,this.endPoint=i}function o(t,e,o){var i,n,r,s=null,a=0;o||(o={});var h=function(){a=!1===o.leading?0:Date.now(),s=null,r=t.apply(i,n),s||(i=n=null)};return function(){var c=Date.now();a||!1!==o.leading||(a=c);var u=e-(c-a);return i=this,n=arguments,u<=0||u>e?(s&&(clearTimeout(s),s=null),a=c,r=t.apply(i,n),s||(i=n=null)):s||!1===o.trailing||(s=setTimeout(h,u)),r}}function i(t){var e=t.getContext("2d"),o=t.width,i=t.height,n=e.getImageData(0,0,o,i).data,r=s(!0,o,i,n),h=s(!1,o,i,n),c=a(!0,o,i,n),u=a(!1,o,i,n),d=u-c+1,l=h-r+1,v=e.getImageData(c,r,d,l);return t.width=d,t.height=l,e.clearRect(0,0,d,l),e.putImageData(v,0,0),t}function n(t,e,o,i){return{red:i[4*(o*e+t)],green:i[4*(o*e+t)+1],blue:i[4*(o*e+t)+2],alpha:i[4*(o*e+t)+3]}}function r(t,e,o,i){return n(t,e,o,i).alpha}function s(t,e,o,i){for(var n=t?1:-1,s=t?0:o-1,a=s;t?a<o:a>-1;a+=n)for(var h=0;h<e;h++)if(r(h,a,e,i))return a;return null}function a(t,e,o,i){for(var n=t?1:-1,s=t?0:e-1,a=s;t?a<e:a>-1;a+=n)for(var h=0;h<o;h++)if(r(a,h,e,i))return a;return null}function h(t,e){var i=this,n=e||{};this.velocityFilterWeight=n.velocityFilterWeight||.7,this.minWidth=n.minWidth||.5,this.maxWidth=n.maxWidth||2.5,this.throttle="throttle"in n?n.throttle:16,this.throttle?this._strokeMoveUpdate=o(h.prototype._strokeUpdate,this.throttle):this._strokeMoveUpdate=h.prototype._strokeUpdate,this.dotSize=n.dotSize||function(){return(this.minWidth+this.maxWidth)/2},this.penColor=n.penColor||"black",this.backgroundColor=n.backgroundColor||"rgba(0,0,0,0)",this.onBegin=n.onBegin,this.onEnd=n.onEnd,this._canvas=t,this._ctx=t.getContext("2d"),this.clear(),this._handleMouseDown=function(t){1===t.which&&(i._mouseButtonDown=!0,i._strokeBegin(t))},this._handleMouseMove=function(t){i._mouseButtonDown&&i._strokeMoveUpdate(t)},this._handleMouseUp=function(t){1===t.which&&i._mouseButtonDown&&(i._mouseButtonDown=!1,i._strokeEnd(t))},this._handleTouchStart=function(t){if(1===t.targetTouches.length){var e=t.changedTouches[0];i._strokeBegin(e)}},this._handleTouchMove=function(t){t.preventDefault();var e=t.targetTouches[0];i._strokeMoveUpdate(e)},this._handleTouchEnd=function(t){t.target===i._canvas&&(t.preventDefault(),i._strokeEnd(t))},this.on()}return t.prototype.velocityFrom=function(t){return this.time!==t.time?this.distanceTo(t)/(this.time-t.time):1},t.prototype.distanceTo=function(t){return Math.sqrt(Math.pow(this.x-t.x,2)+Math.pow(this.y-t.y,2))},e.prototype.length=function(){for(var t=0,e=void 0,o=void 0,i=0;i<=10;i+=1){var n=i/10,r=this._point(n,this.startPoint.x,this.control1.x,this.control2.x,this.endPoint.x),s=this._point(n,this.startPoint.y,this.control1.y,this.control2.y,this.endPoint.y);if(i>0){var a=r-e,h=s-o;t+=Math.sqrt(a*a+h*h)}e=r,o=s}return t},e.prototype._point=function(t,e,o,i,n){return e*(1-t)*(1-t)*(1-t)+3*o*(1-t)*(1-t)*t+3*i*(1-t)*t*t+n*t*t*t},h.prototype.clear=function(){var t=this._ctx,e=this._canvas;t.fillStyle=this.backgroundColor,t.clearRect(0,0,e.width,e.height),t.fillRect(0,0,e.width,e.height),this._data=[],this._reset(),this._isEmpty=!0},h.prototype.fromDataURL=function(t){var e=this,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=new Image,n=o.ratio||window.devicePixelRatio||1,r=o.width||this._canvas.width/n,s=o.height||this._canvas.height/n;this._reset(),i.src=t,i.onload=function(){e._ctx.drawImage(i,0,0,r,s)},this._isEmpty=!1},h.prototype.toDataURL=function(t){var e;switch(t){case"image/svg+xml":return this._toSVG();default:for(var o=arguments.length,i=Array(o>1?o-1:0),n=1;n<o;n++)i[n-1]=arguments[n];return(e=this._canvas).toDataURL.apply(e,[t].concat(i))}},h.prototype.on=function(){this._handleMouseEvents(),this._handleTouchEvents()},h.prototype.off=function(){this._canvas.removeEventListener("mousedown",this._handleMouseDown),this._canvas.removeEventListener("mousemove",this._handleMouseMove),document.removeEventListener("mouseup",this._handleMouseUp),this._canvas.removeEventListener("touchstart",this._handleTouchStart),this._canvas.removeEventListener("touchmove",this._handleTouchMove),this._canvas.removeEventListener("touchend",this._handleTouchEnd)},h.prototype.isEmpty=function(){return this._isEmpty},h.prototype._strokeBegin=function(t){this._data.push([]),this._reset(),this._strokeUpdate(t),"function "==typeof this.onBegin&&this.onBegin(t)},h.prototype._strokeUpdate=function(t){var e=t.clientX,o=t.clientY,i=this._createPoint(e,o),n=this._addPoint(i),r=n.curve,s=n.widths;r&&s&&this._drawCurve(r,s.start,s.end),this._data[this._data.length-1].push({x:i.x,y:i.y,time:i.time,color:this.penColor})},h.prototype._strokeEnd=function(t){var e=this.points.length>2,o=this.points[0];!e&&o&&this._drawDot(o),"function "==typeof this.onEnd&&this.onEnd(t)},h.prototype._handleMouseEvents=function(){this._mouseButtonDown=!1,this._canvas.addEventListener("mousedown",this._handleMouseDown),this._canvas.addEventListener("mousemove",this._handleMouseMove),document.addEventListener("mouseup",this._handleMouseUp)},h.prototype._handleTouchEvents=function(){this._canvas.style.msTouchAction="none",this._canvas.style.touchAction="none",this._canvas.addEventListener("touchstart",this._handleTouchStart),this._canvas.addEventListener("touchmove",this._handleTouchMove),this._canvas.addEventListener("touchend",this._handleTouchEnd)},h.prototype._reset=function(){this.points=[],this._lastVelocity=0,this._lastWidth=(this.minWidth+this.maxWidth)/2,this._ctx.fillStyle=this.penColor},h.prototype._createPoint=function(e,o,i){var n=this._canvas.getBoundingClientRect();return new t(e-n.left,o-n.top,i||(new Date).getTime())},h.prototype._addPoint=function(t){var o=this.points,i=void 0;if(o.push(t),o.length>2){3===o.length&&o.unshift(o[0]),i=this._calculateCurveControlPoints(o[0],o[1],o[2]);var n=i.c2;i=this._calculateCurveControlPoints(o[1],o[2],o[3]);var r=i.c1,s=new e(o[1],n,r,o[2]),a=this._calculateCurveWidths(s);return o.shift(),{curve:s,widths:a}}return{}},h.prototype._calculateCurveControlPoints=function(e,o,i){var n=e.x-o.x,r=e.y-o.y,s=o.x-i.x,a=o.y-i.y,h={x:(e.x+o.x)/2,y:(e.y+o.y)/2},c={x:(o.x+i.x)/2,y:(o.y+i.y)/2},u=Math.sqrt(n*n+r*r),d=Math.sqrt(s*s+a*a),l=h.x-c.x,v=h.y-c.y,p=d/(u+d),_={x:c.x+l*p,y:c.y+v*p},f=o.x-_.x,y=o.y-_.y;return{c1:new t(h.x+f,h.y+y),c2:new t(c.x+f,c.y+y)}},h.prototype._calculateCurveWidths=function(t){var e=t.startPoint,o=t.endPoint,i={start:null,end:null},n=this.velocityFilterWeight*o.velocityFrom(e)+(1-this.velocityFilterWeight)*this._lastVelocity,r=this._strokeWidth(n);return i.start=this._lastWidth,i.end=r,this._lastVelocity=n,this._lastWidth=r,i},h.prototype._strokeWidth=function(t){return Math.max(this.maxWidth/(t+1),this.minWidth)},h.prototype._drawPoint=function(t,e,o){var i=this._ctx;i.moveTo(t,e),i.arc(t,e,o,0,2*Math.PI,!1),this._isEmpty=!1},h.prototype._drawCurve=function(t,e,o){var i=this._ctx,n=o-e,r=Math.floor(t.length());i.beginPath();for(var s=0;s<r;s+=1){var a=s/r,h=a*a,c=h*a,u=1-a,d=u*u,l=d*u,v=l*t.startPoint.x;v+=3*d*a*t.control1.x,v+=3*u*h*t.control2.x,v+=c*t.endPoint.x;var p=l*t.startPoint.y;p+=3*d*a*t.control1.y,p+=3*u*h*t.control2.y,p+=c*t.endPoint.y;var _=e+c*n;this._drawPoint(v,p,_)}i.closePath(),i.fill()},h.prototype._drawDot=function(t){var e=this._ctx,o="function "==typeof this.dotSize?this.dotSize():this.dotSize;e.beginPath(),this._drawPoint(t.x,t.y,o),e.closePath(),e.fill()},h.prototype._fromData=function(e,o,i){for(var n=0;n<e.length;n+=1){var r=e[n];if(r.length>1)for(var s=0;s<r.length;s+=1){var a=r[s],h=new t(a.x,a.y,a.time),c=a.color;if(0===s)this._reset(),this._addPoint(h);else if(s!==r.length-1){var u=this._addPoint(h),d=u.curve,l=u.widths;d&&l&&o(d,l,c)}}else{this._reset();i(r[0])}}},h.prototype._toSVG=function(){var t=this,e=this._data,o=this._canvas,i=Math.max(window.devicePixelRatio||1,1),n=o.width/i,r=o.height/i,s=document.createElementNS("http://www.w3.org/2000/svg","svg");s.setAttributeNS(null,"width",o.width),s.setAttributeNS(null,"height",o.height),this._fromData(e,function(t,e,o){var i=document.createElement("path");if(!(isNaN(t.control1.x)||isNaN(t.control1.y)||isNaN(t.control2.x)||isNaN(t.control2.y))){var n="M "+t.startPoint.x.toFixed(3)+","+t.startPoint.y.toFixed(3)+" C "+t.control1.x.toFixed(3)+","+t.control1.y.toFixed(3)+" "+t.control2.x.toFixed(3)+","+t.control2.y.toFixed(3)+" "+t.endPoint.x.toFixed(3)+","+t.endPoint.y.toFixed(3);i.setAttribute("d",n),i.setAttribute("stroke-width",(2.25*e.end).toFixed(3)),i.setAttribute("stroke",o),i.setAttribute("fill","none"),i.setAttribute("stroke-linecap","round"),s.appendChild(i)}},function(e){var o=document.createElement("circle"),i="function "==typeof t.dotSize?t.dotSize():t.dotSize;o.setAttribute("r",i),o.setAttribute("cx",e.x),o.setAttribute("cy",e.y),o.setAttribute("fill",e.color),s.appendChild(o)});var a='<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 '+n+" "+r+'" width="'+n+'" height="'+r+'">',h=s.innerHTML;if(void 0===h){var c=document.createElement("dummy"),u=s.childNodes;c.innerHTML="";for(var d=0;d<u.length;d+=1)c.appendChild(u[d].cloneNode(!0));h=c.innerHTML}var l=a+h+"</svg>";return"data:image/svg+xml;base64,"+btoa(l)},h.prototype.fromData=function(t){var e=this;this.clear(),this._fromData(t,function(t,o){return e._drawCurve(t,o.start,o.end)},function(t){return e._drawDot(t)})},h.prototype.toData=function(){return this._data},h.prototype.trimCanvas=function(){return i(this._canvas)},h});
